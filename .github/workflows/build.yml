name: CI Build

on: push

jobs:
  tests:
    name: tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Update apt
        run: sudo apt-get update

      - name: Clone the grug submodule
        run: git submodule update --init

      - name: Compile libgrug.so
        run: gcc grug/grug.c -o src/main/resources/natives/libgrug.so -shared -fPIC -Wall -Wextra -Werror -Wpedantic -Wshadow -Wfatal-errors -g -rdynamic

      # To get a list of all the installed Java version, you can add a job that runs `update-alternatives --config java`.
      - name: Compile libglobal_library_loader.so
        run: gcc global_library_loader.c -o src/main/resources/natives/libglobal_library_loader.so -shared -fPIC -Wall -Wextra -Werror -Wpedantic -Wshadow -Wfatal-errors -g -I/usr/lib/jvm/temurin-17-jdk-amd64/include -I/usr/lib/jvm/temurin-17-jdk-amd64/include/linux

      - name: Regenerate adapter.c
        run: python3 grug-adapter-for-java/generate.py mod_api.json adapter.c com/example/examplemod Grug

      - name: Compile libadapter.so
        run: gcc adapter.c -o src/main/resources/natives/libadapter.so -shared -fPIC -Wall -Wextra -Werror -Wpedantic -Wshadow -Wfatal-errors -g -I/usr/lib/jvm/temurin-17-jdk-amd64/include -I/usr/lib/jvm/temurin-17-jdk-amd64/include/linux

      - name: Run the tests
        run: ./gradlew runGameTestServer
